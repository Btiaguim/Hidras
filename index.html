<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Registo de Hidras - Metin2</title>
<style>
  body { font-family: Arial, sans-serif; background: #1a1a1a; color: #fff; margin:0; padding:0; }
  .banner { width: 100%; max-height: 200px; object-fit: contain; margin-bottom: 20px; }
  .container { display: flex; flex-wrap: wrap; justify-content: space-around; align-items: flex-start; padding: 20px; box-sizing: border-box; }
  .section { background: #2b2b2b; padding: 20px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.5); width: 30%; min-width: 280px; margin-bottom:20px; }
  .section h2 { text-align: center; margin-bottom:10px; }
  button, input, select { color: #fff; background: #3a3a3a; padding: 10px; margin-top: 10px; border-radius: 8px; border: none; font-size: 16px; width: 100%; box-sizing: border-box; }
  button { background: #4CAF50; cursor: pointer; }
  button:hover { background: #45a049; }
  .timer { font-size: 40px; text-align: center; margin-top: 15px; letter-spacing: 5px; display:flex; justify-content:center; gap:5px; }
  .digit-box { background:#3a3a3a; padding:10px 15px; border-radius:5px; }
  .hidra-icon, .cofre-icon { width: 24px; height: 24px; vertical-align: middle; margin-right: 5px; }
  #totaisSempre { background:#3a3a3a; padding:15px; border-radius:8px; margin-top:15px; text-align:center; }
  #graficoContainer { width:100%; height:200px; margin-top:15px; }
  @media(max-width: 900px){ .section{width:90%;} }
  .dark-mode { background:#121212; color:#fff; }
  .dark-mode .section { background:#1f1f1f; }
  .dark-mode button,input,select { background:#333; color:#fff; }
</style>
</head>
<body>

<img src="https://image.board.gameforge.com/uploads/metin2/de/announcement_metin2_de_b9a65d2955858ca2f0b20ab0e2de48d2.jpg" alt="Banner Hidra Tracker" class="banner" />

<div class="container">
  <!-- Timer Section -->
  <div class="section" id="timerSection">
    <h2>Timer da Hidra</h2>
    <label>Defina os minutos:</label>
    <input type="number" id="minutosTimer" value="20" min="1" />
    <button onclick="iniciarTimer()">Iniciar</button>
    <button onclick="pararTimer()">Parar</button>
    <button onclick="resetarTimer()">Resetar</button>
    <div id="timer" class="timer">
      <div class="digit-box" id="minTens">2</div>
      <div class="digit-box" id="minUnits">0</div>
      <div class="digit-box">:</div>
      <div class="digit-box" id="secTens">0</div>
      <div class="digit-box" id="secUnits">0</div>
    </div>
    <div id="totaisSempre">
      <h3>Total de Hidras Desde Sempre: <span id="hidrasSempre">0</span></h3>
      <h3>Total de Cofres Desde Sempre: <span id="cofresSempre">0</span></h3>
      <h3>Total Ganho Desde Sempre: <span id="ganhosSempre">0 W</span></h3>
    </div>
  </div>

  <!-- Hidra Info Section -->
  <div class="section" id="hidraInfo">
    <h2>Registo de Hidras</h2>
    <label>Total Hidras Mortas:</label>
    <input type="number" id="hidras" value="0" disabled />
    <label>Cofres Dropados (0-5):</label>
    <input type="number" id="cofresInput" placeholder="Digite os cofres da √∫ltima hidra" min="0" max="5" />
    <label>Pre√ßo m√©dio do Cofre (kk):</label>
    <input type="number" id="precoCofre" placeholder="36 a 40" min="36" max="40" />
    <button id="btnRegistrar" onclick="registrarHidra()">Registrar Hidra</button>
    <h3>Cofres Totais: <img src="https://metin2cms.cf/items/img/icons/54705.png" class="cofre-icon" /><span id="cofresTotal">0</span></h3>
    <h3>M√©dia por Hidra: <span id="media">0</span></h3>
    <h3>Total Hidras: <span id="totalHidras">0</span></h3>
    <h3>Ganhos: <span id="ganhosWon">0 W</span></h3>
    <label>Selecionar Dia:</label>
    <select id="selecionarDia" onchange="mostrarDiaSelecionado()"></select>
    <div id="historicoDia"></div>
  </div>

  <!-- Admin Section -->
  <div class="section" id="adminSectionContainer">
    <h2>√Årea Administrativa</h2>
    <label>Seu Nick:</label>
    <input type="text" id="nick" placeholder="Digite seu nickname" />
    <button onclick="mostrarAdmin()" style="background:#c0392b;">Mostrar/Ocultar Admin</button>
    <div id="adminSection" style="margin-top:10px;">
      <button onclick="resetarTudo()" style="background:#c0392b;">Resetar Hist√≥rico</button>
      <button onclick="eliminarDia()" style="background:#e67e22;">Eliminar Dia Selecionado</button>
      <button id="publicar">Publicar no Discord</button>
      <button onclick="alternarModo()">Escuro/Claro</button>
      <div id="graficoContainer"><canvas id="graficoHidras"></canvas></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let hidras = parseInt(localStorage.getItem('hidras')) || 0;
let cofresTotais = parseInt(localStorage.getItem('cofresTotais')) || 0;
let historico = JSON.parse(localStorage.getItem('historico')) || [];
let countdown; 
let tempoRestante = 0;
const webhookURL = "https://discordapp.com/api/webhooks/1446135504868479202/voxMQ-6MyNCg6MvC9Q3Fv-l4Q6jX9qNmQS4edg39_bQFfv_gdr6ha5IjQ9mWSkj4ZkbJ";

// Mostrar/Ocultar admin
function mostrarAdmin(){ 
  const section=document.getElementById('adminSection'); 
  section.style.display=section.style.display==='none'?'block':'none'; 
}

// Totais ‚Äúdesde sempre‚Äù
function atualizarTotaisSempre(){
  let totalHidras = 0, totalCofres=0, totalProfit=0;
  historico.forEach(h=>{ totalHidras+=1; totalCofres+=h.cofres; totalProfit+=h.profitWon; });
  document.getElementById('hidrasSempre').innerText = totalHidras;
  document.getElementById('cofresSempre').innerText = totalCofres;
  document.getElementById('ganhosSempre').innerText = totalProfit.toFixed(2)+" W";
}

// Stats da sess√£o atual
function atualizarStats(){
  const hoje = new Date().toLocaleDateString('pt-PT');
  let totalDia = historico.filter(h=>h.data===hoje);
  document.getElementById('hidras').value = totalDia.length;
  let cofresDia = totalDia.reduce((a,b)=>a+b.cofres,0);
  document.getElementById('cofresTotal').innerText = cofresDia;
  document.getElementById('media').innerText = totalDia.length? (cofresDia/totalDia.length).toFixed(2):0;
  let totalWon = totalDia.reduce((a,b)=>a+b.profitWon,0);
  document.getElementById('totalHidras').innerText = totalDia.length;
  document.getElementById('ganhosWon').innerText = totalWon.toFixed(2)+" W";
  atualizarTotaisSempre();
  atualizarGrafico();
  bloquearDiasAnteriores();
}

// Bloquear inputs se dia n√£o for hoje
function bloquearDiasAnteriores(){
  const hoje = new Date().toLocaleDateString('pt-PT');
  const selectDia = document.getElementById('selecionarDia').value;
  const isHoje = selectDia === hoje;
  document.getElementById('cofresInput').disabled = !isHoje;
  document.getElementById('precoCofre').disabled = !isHoje;
  document.getElementById('btnRegistrar').disabled = !isHoje;
}

// Atualizar select e hist√≥rico
function atualizarDias(){
  const select=document.getElementById('selecionarDia');
  const dias=[...new Set(historico.map(h=>h.data))];
  select.innerHTML='';
  const hoje = new Date().toLocaleDateString('pt-PT');
  if(!dias.includes(hoje)) dias.push(hoje); // garante que dia atual aparece
  dias.forEach(dia=>{ const option=document.createElement('option'); option.value=dia; option.textContent=dia; select.appendChild(option); });
  select.value = hoje; // sempre seleciona hoje
  mostrarDiaSelecionado();
}

// Mostrar hist√≥rico do dia selecionado
function mostrarDiaSelecionado(){
  const dia=document.getElementById('selecionarDia').value;
  const div=document.getElementById('historicoDia'); div.innerHTML='';
  const hidraImg='https://en-wiki.metin2.gameforge.com/images/thumb/9/9d/Hydra.png/200px-Hydra.png';
  let contador = 1;
  historico.filter(h=>h.data===dia).forEach(item=>{
    const p=document.createElement('p');
    p.innerHTML=`<img src='${hidraImg}' class='hidra-icon' /> Hidra-${contador} - <img src='https://metin2cms.cf/items/img/icons/54705.png' class='cofre-icon' /> Cofres: ${item.cofres} ‚Äì Profit: ${item.profit.toFixed(2)}kk (~${item.profitWon.toFixed(2)} W)`;
    div.appendChild(p);
    contador++;
  });
  bloquearDiasAnteriores();
}

// Registrar nova hidra
function registrarHidra(){
  let cofres=parseInt(document.getElementById("cofresInput").value);
  if(isNaN(cofres)||cofres<0||cofres>5)return alert("Insira um valor entre 0 e 5.");
  let precoCofre=parseFloat(document.getElementById('precoCofre').value);
  if(isNaN(precoCofre)||precoCofre<36||precoCofre>50)return alert('Insira o pre√ßo m√©dio do cofre entre 36 e 50 kk.');
  const hoje=new Date().toLocaleDateString('pt-PT');
  let profit = cofres*precoCofre;
  let profitWon = profit/100;
  historico.push({cofres, data:hoje, profit, profitWon});
  localStorage.setItem('historico', JSON.stringify(historico));
  document.getElementById('cofresInput').value='';
  atualizarStats();
}

/* -------------------- TIMER -------------------- */
function iniciarTimer(){
  let minutos=parseInt(document.getElementById('minutosTimer').value); 
  if(isNaN(minutos)||minutos<=0)minutos=20;
  let fim=localStorage.getItem('timerFim');
  if(!fim||tempoRestante<=0){ fim=Date.now()+minutos*60000; localStorage.setItem('timerFim',fim); }
  fim=parseInt(fim); clearInterval(countdown);
  countdown=setInterval(()=>{
    const restante=Math.max(0,Math.floor((fim-Date.now())/1000));
    const min=Math.floor(restante/60); const sec=restante%60;
    document.getElementById('minTens').innerText=Math.floor(min/10);
    document.getElementById('minUnits').innerText=min%10;
    document.getElementById('secTens').innerText=Math.floor(sec/10);
    document.getElementById('secUnits').innerText=sec%10;
    tempoRestante=restante;
    if(restante<=0){ clearInterval(countdown); localStorage.removeItem('timerFim'); notificacaoWindows("O tempo da Hidra acabou!"); }
  },1000);
}

function pararTimer(){ clearInterval(countdown); }
function resetarTimer(){ 
  clearInterval(countdown); tempoRestante=0;
  document.getElementById('minTens').innerText='2';
  document.getElementById('minUnits').innerText='0';
  document.getElementById('secTens').innerText='0';
  document.getElementById('secUnits').innerText='0';
  localStorage.removeItem('timerFim'); 
}

// Notifica√ß√£o Windows
function notificacaoWindows(texto){
  if(Notification.permission!=='granted') Notification.requestPermission().then(perm=>{ if(perm==='granted') new Notification(texto); });
  else new Notification(texto);
}

/* -------------------- ADMIN -------------------- */
function resetarTudo(){ if(confirm('Tem certeza que deseja resetar tudo?')){ localStorage.clear(); hidras=0; cofresTotais=0; historico=[]; atualizarStats(); atualizarDias(); } }
function eliminarDia(){ 
  const dia=document.getElementById('selecionarDia').value; 
  if(!dia)return alert('Selecione um dia'); 
  if(confirm(`Deseja eliminar todos os registros do dia ${dia}?`)){ 
    historico=historico.filter(h=>h.data!==dia); 
    localStorage.setItem('historico',JSON.stringify(historico)); 
    atualizarDias(); 
  } 
}

/* -------------------- DISCORD -------------------- */
document.getElementById("publicar").addEventListener("click", publicarDiscord);
function publicarDiscord(){
  const nick=document.getElementById("nick").value.trim(); if(!nick)return alert("Digite seu nick");
  const dia=document.getElementById("selecionarDia").value; if(!dia)return alert("Selecione um dia");
  const dadosDia=historico.filter(h=>h.data===dia); if(dadosDia.length===0)return alert("Esse dia n√£o tem registos");
  let totalCofres=0; let totalWon=0; let textoHidras="";
  dadosDia.forEach((h,i)=>{ totalCofres+=h.cofres; totalWon+=h.profitWon; textoHidras+=`‚Ä¢ Hidra-${i+1} ‚Üí ${h.cofres} cofres\n`; });
  const payload={content:`üì¢ Novo registo de Hidras publicado por ${nick}!`, embeds:[{title:`Registo do dia ${dia}`, color:3066993, fields:[{name:"Jogador", value:nick, inline:true},{name:"Hidras Mortas", value:`${dadosDia.length}`, inline:true},{name:"Cofres Totais", value:`${totalCofres}`, inline:true},{name:"Ganho Total", value:`${totalWon.toFixed(2)} W`, inline:true},{name:"Detalhes", value:textoHidras}],footer:{text:"Sistema Autom√°tico ‚Äî Hidra Tracker"}}]};
  fetch(webhookURL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)}).then(res=>{if(res.ok)alert("Publicado com sucesso!"); else alert("Erro ao publicar")}).catch(()=>alert("Erro ao conectar ao Discord"));
}

/* -------------------- MODO ESCURO -------------------- */
function alternarModo(){ document.body.classList.toggle("dark-mode"); }

/* -------------------- GR√ÅFICO -------------------- */
let ctx=document.getElementById('graficoHidras').getContext('2d');
let grafico=new Chart(ctx,{type:'bar',data:{labels:[],datasets:[{label:'Hidras Mortas',data:[],backgroundColor:'rgba(75,192,192,0.5)',borderColor:'rgba(75,192,192,1)',borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
function atualizarGrafico(){
  const dias=[...new Set(historico.map(h=>h.data))];
  grafico.data.labels=dias;
  grafico.data.datasets[0].data=dias.map(d=>historico.filter(h=>h.data===d).length);
  grafico.update();
}

/* -------------------- ON LOAD -------------------- */
window.onload=()=>{
  const fim=localStorage.getItem('timerFim');
  if(fim){ tempoRestante=Math.max(0,Math.floor((fim-Date.now())/1000)); if(tempoRestante>0)iniciarTimer(); }
  atualizarStats();
  atualizarDias();
  mostrarDiaSelecionado();
};
</script>

</body>
</html>
